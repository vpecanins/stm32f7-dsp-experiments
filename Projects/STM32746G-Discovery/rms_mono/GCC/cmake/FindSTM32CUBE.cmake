SET(STM32CUBE_SEARCH_PATHS ".." "../.." "../../.." "../../../.." "../../../../..")

IF(CHIP_PLATFORM STREQUAL "STM32")
	MESSAGE(STATUS "Searching for STM32Cube SDK.")
ELSE()
	MESSAGE(FATAL_ERROR "STM32Cube SDK is only supported with STM32 platform.")
ENDIF()

FUNCTION(CHECK_STM32CUBE B_PATH)
	GET_FILENAME_COMPONENT(A_PATH ${B_PATH} ABSOLUTE)
	IF(NOT EXISTS ${A_PATH})
		SET(IS_STM32CUBE FALSE PARENT_SCOPE)
	ELSE()
		IF(NOT EXISTS ${A_PATH}/Drivers)
			SET(IS_STM32CUBE FALSE PARENT_SCOPE)
		ELSE()
			IF(NOT EXISTS ${A_PATH}/Drivers/CMSIS)
				SET(IS_STM32CUBE FALSE PARENT_SCOPE)
			ELSEIF(NOT EXISTS ${A_PATH}/Drivers/BSP)
				SET(IS_STM32CUBE FALSE PARENT_SCOPE)
			ELSE()
				FILE(GLOB C_PATH "${A_PATH}/Drivers/${CHIP_PLATFORM}${CHIP_FAMILY}*")
				IF(C_PATH)
					SET(IS_STM32CUBE TRUE PARENT_SCOPE)
				ELSE()
					SET(IS_STM32CUBE FALSE PARENT_SCOPE)
				ENDIF()
			ENDIF()
		ENDIF()
	ENDIF()
ENDFUNCTION()

IF(NOT STM32CUBE_PATH) 
	FOREACH(i ${STM32CUBE_SEARCH_PATHS})
		CHECK_STM32CUBE(${i})
		IF(IS_STM32CUBE)
			SET(STM32CUBE_PATH ${i})
			MESSAGE(STATUS "Found STM32CUBE: ${STM32CUBE_PATH}")
			BREAK()
		ENDIF()
	ENDFOREACH()
	IF(NOT STM32CUBE_PATH)
		MESSAGE(FATAL_ERROR "Could not find STM32CUBE in any of the search paths: ${STM32CUBE_SEARCH_PATHS}") 
	ENDIF()
ELSE()
	CHECK_STM32CUBE(STM32CUBE_PATH)
	IF(IS_STM32CUBE)
		MESSAGE(STATUS "Using supplied STM32CUBE_PATH: ${STM32CUBE_PATH}") 
	ELSE()
		MESSAGE(FATAL_ERROR "STM32Cube not found in STM32CUBE_PATH: ${STM32CUBE_PATH}")
	ENDIF()
ENDIF()

INCLUDE(FindPackageHandleStandardArgs) 
FIND_PACKAGE_HANDLE_STANDARD_ARGS(STM32CUBE DEFAULT_MSG STM32CUBE_PATH STM32CUBE_INCLUDE_DIRS STM32CUBE_SOURCES) 
